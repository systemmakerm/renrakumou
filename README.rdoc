= renrakumou: A Rails application that automatically sends e-mail

== renrakumouとは
特定された人員に対し回答機能付きメールを一斉配信するシステムです。
主な機能として以下の機能を備えています。

* メール受信者の階層的所属グループ管理
* グループ別送信、メール受信者本人または家族の区分指定送信、個人指定可能な送信機能
* メール受信者本人によるメールアドレス登録および退会機能
* ユーザー管理機能
* メール管理機能
* 開封確認およびアンケート機能
* 同一メールアドレス、パスワードによる複数の連絡網作成機能

= renrakumouの導入手順 
== 必要な環境
=== OS
* LinuxでRubyが利用可能なシステムを想定しています。 
* RubyおよびRailsのバージョンは以下の通りです。
Ruby 1.8.7
Rails 2.3.5
Ruby on Railsはインストールを別途行う必要があります。
* データベース   posgresql 8

== 導入手順
=== 1.リポジトリからダウンロードし、ダウンロードしたフォルダを解凍します。
 tar  xvf  renrakumou.tar.gz 
=== 2.config/database.yml を編集し、データベースの設定を行ってください。
例)
 development:
 adapter:  postgresql
 encoding:  utf8
 database:  postgres #postgres データベース名
 host: localhost
 username:  posgreuser #postgres ユーザ名
 password:  posgreword #postgres パスワード 
 
=== 3.下記コマンドを$RAILS_ROOTで実行し、データベースを作成します:
 rake db:create 
 
=== 4.下記コマンドを実行し、デフォルトのテーブルを作成します。
 rake db:migrate 

=== 5.config/environment.rbに接続するメールサーバーの記述をする
 config.action_mailer.delivery_method = :smtp
 config.action_mailer.smtp_settings = {
 :enable_starttls_auto => true,
 :address => 'mail domain', #サーバー名
 :port => 25,               #ポート番号
 :domain => 'domain',
 :authentication => :plain, #接続の認証方式
 :user_name => '',          #ユーザー名
 :password => ''            #パスワード
 }

=== 6.下記コマンドを$RAILS_ROOTで実行、webサーバを起動してください
 script/server
サーバーが起動したら、ブラウザで http://localhost:3000/ を開いてください。連絡網のログイン・団体新規登録する画面が表示されれば導入完了です。 

=== 7.スーパー管理者作成のスクリプト
 vendor/script/create_superadmin.rb 
に保守・管理目的のユーザー「スーパー管理者」を作成するスクリプトがあります。以下の記述にスーパー管理者用のメールアドレスとパスワードを入力してください。
 account = Account.new(:status => 0,
 :login => "renrakumou@example.com",              ＃スーパー管理者メールアドレス
 :login_confirmation => "renrakumou@example.com", ＃スーパー管理者メールアドレス
 :password => "password here",                    ＃スーパー管理者パスワード
 :password_confirmation => "password here",       ＃スーパー管理者パスワード
 :state => 'active',
 :activated_at => Time.now)
スクリプトの編集が完了したら、以下のコマンドでスクリプトの実行してください。 
 $RAILS_ROOT/script/runner script/runner/create_superadmin.rb 

=== オプション
受信者作成のスクリプト
登録された団体に所属する受信者を一括して作成するスクリプトとして下記があります。
 vendor/script/create_recipients.rb
デフォルトでは500人の受信者が登録されるようになっています。 以下のコマンドで実行されます。
 $RAILS_ROOT/script/runner script/runner/create_recipients.rb

= 回答機能付き自動一斉配信システム操作マニュアル
* 本資料はテキストのみの内容となっております。操作画面付きの、より詳細なマニュアルはフォルダ名「files」内に「manual」というファイル名のpdf形式でありますので、そちらをご参照ください。

== はじめに
本資料に出てくる用語を以下のように定義します。
* スーパー管理者：システム全体の保守・管理の権限を有するアカウント。団体の持つ機能の他、団体の運用停止・再開が可能。
* 団体：１つの連絡網を運用する組織・集団、またはその代表者のアカウント。マスタ管理の機能が使用可能。
* 管理者：所属する連絡網のメール送信機能のみ使用可能なアカウント。
* ユーザー：所属する連絡網のメールを受信するエンドユーザーのアカウント。
* 受信者：ユーザーのメールアドレスを保有するためのアカウント。１つのユーザーアカウントが複数の受信者アカウントを持つことが可能。

== 1 団体管理
連絡網の運用者はまずシステムに「団体」の登録を行います。

=== 1.1 団体登録

システムのサーバーのポート(ローカルで3000ポート指定の場合localhost:3000)をブラウザで開きますとトップ画面が開きます。
「団体新規登録」を選択します。
「団体登録」画面が開くので、団体情報を入力し「確認」を押します。
「団体登録確認」画面が開くので入力内容の確認をし、誤りがあれば「戻る」を押して入力画面に戻ります。誤りがなければ「保存」を押します。
「団体仮登録完了」画面が開き、入力したメールアドレスにメールが送信されるのでメールを確認します。

 test 様
 「Renrakumou」へ登録をしていただき誠にありがとうございます。
 本登録のお知らせ
 「Renrakumou」の団体登録を完了するためには
 以下のリンクをクリックし、登録を完了させてください。
 http://hogehoge/activate/45daa245155a323b3e6b57b38b95686f2c709c7c
 上記内容のメールが届くので、URLをクリックします。

「本登録確認」画面が開くので、「本登録する」を押すと団体登録が完了します。

=== 1.2 ログイン・ログアウト
トップ画面で「ログイン画面へ」を選択します。
「ログイン」画面が開くので、登録したメールアドレスとパスワードを入力して「ログイン」を押します。
登録した団体の明細とサイドメニューが表示されればログイン成功です。
ログアウトはヘッダ右上の「ログアウト」をクリックするだけです。

=== 1.3 団体編集
サイドメニューの「団体編集」をクリックします。
団体登録と同様の内容の画面が表示され、団体情報の編集が行えます。

=== 1.4 団体解約
サイドメニューの「団体解約」をクリックします。
「解約」画面が開き、「解約する」を押すと確認のメッセージが表示され、「OK」を選択すると団体の運用が停止されます。

== 2 グループ管理
メール送信先をグループで指定可能です。
グループ管理機能として、登録、一覧、編集、削除機能があります。

=== 2.1 グループ登録
サイドメニューの「グループ一覧」をクリックします。
「グループ一覧」が開くので、「新規作成」をクリックします。
グループは階層化可能であり、3階層まで登録できます。
「グループ登録」画面では、左側の欄で上位グループを選択します（初回登録時は「指定なし」しか表示されません）。右側の欄でグループ名を入力し、「保存」を押します。
「グループ一覧」画面に戻り、登録完了です。

=== 2.2 グループ一覧
「グループ一覧」画面では、階層化されたグループがツリー構造で表示されます。
グループ名左側の「＋」を押すと下の階層が表示され、「－」を押すと下の階層が非表示になります。

=== 2.3 グループ編集
「グループ一覧」のグループ名をクリックすると、「グループ明細」画面が開きます。
上位グループ、グループ名が編集可能であり、「保存」を押して編集完了です。

=== 2.4 グループ削除
前述の2.3の「グループ明細」画面で、「削除」を押すと確認のメッセージが表示され「OK」を押して削除完了です。

== 3 ユーザー管理
メールを受信するエンドユーザーのアカウントとしてユーザーアカウントがあります。
ユーザー管理機能として、登録、検索、編集、削除機能があります。

=== 3.1 ユーザー登録
サイドメニュー「ユーザー検索/登録」をクリックします。
「ユーザー検索」画面が開き、「新規登録」をクリックします。
「ユーザー登録」画面が開きます。登録番号・ユーザー名・メモ・グループの所属入力し、「確認」を押します。
「保存」を押し、ユーザー登録完了です。

=== 3.2 ユーザー検索
登録したユーザーは「ユーザー検索」画面で検索、参照可能です。
検索条件として、所属グループ、登録番号、名前で絞込みが可能です。

=== 3.3 ユーザー編集
前述の3.2の「ユーザー検索」画面の検索結果で表示される「ユーザー名」をクリックします。
「ユーザー明細」画面が開き、「ユーザー編集」を押します。
「ユーザー登録」画面が開き、ユーザー情報が編集可能です。

編集したら「確認」を押し、編集完了です。

=== 3.4 ユーザー削除
前述の3.3の「ユーザー明細」画面を開きます。
「ユーザー削除」を押すと、確認のメッセージが表示され、「OK」を押して削除完了です。

== 4 受信者管理
前述の3.1では受信するユーザーのアカウントを登録したのみで、メールアドレスはそれを保持するためのアカウント「受信者」の情報として登録します。
受信者管理機能として、登録、一覧、編集、削除機能があります。

=== 4.1 受信者登録
「ユーザー明細」画面を開きます（ユーザー明細画面の開き方は3.3をご参照下さい）。
「受信者登録」を押します。
「受信者登録」画面が開きます。、受信者情報とパスワードを入力し、「確認」を押します。
「受信者登録確認」画面で入力内容の確認をし、「保存」を押します。
「受信者登録完了」画面が表示され、受信者の登録完了です。
１つのユーザーに対し、複数の受信者（メールアドレス）が登録可能ですので、同じユーザーに受信者を追加される場合は「続けて受信者登録をする」を押します。
また、ユーザー検索に戻りたい場合は「ユーザー検索に戻る」を押します。

=== 4.2 受信者一覧
受信者一覧は「ユーザー明細」画面（画面の開き方は3.3をご参照下さい）を開くと画面下に、そのユーザーに結びついた受信者の一覧として参照可能です。

=== 4.3 受信者編集
前述の4.2の受信者一覧の「受信者名」をクリックします。
「受信者明細」画面が開き、「編集」をクリックします。
「受信者編集」が開き、入力内容の編集を行ったら「確認」を押し、編集完了です。

=== 4.4 受信者削除
前述の4.3の「受信者明細」画面を開きます。
「削除」を押すと、確認のメッセージが表示され、「OK」を押して削除完了です。

== 5 ユーザーグループ一括変更
複数のユーザーのグループを一括して変更が可能です。操作は以下の手順で行います。
サイドメニューの「ユーザーグループ一括変更」をクリックします。
変更したいユーザーの検索条件を入力し、「検索」を押します。
該当するユーザーが一覧表示されます。
グループ変更するユーザーにチェックを入れて、移動先のグループを選択して「変更」を押します。
「ユーザーグループ変更確認」が表示され、「変更」を押すと実行されます。
「ユーザーグループ変更」画面に戻りましたら、変更完了です。

== 6 メールひな形管理
メールの件名および本文のひな形を登録が可能です。登録は以下の手順で行います。
メールひな形管理機能として、登録、一覧、編集、削除機能があります。

=== 6.1 メールひな形登録
サイドメニューの「メールひな形一覧」をクリックします。
「新規作成」をクリックします。
メールひな形は階層的に登録可能です。上記画面左側で上位グループを選択、右側の欄でメールひな形グループ名、件名、本文を入力し、「保存」を押して登録完了です。

=== 6.2 メールひな形一覧
「メールひな形一覧」画面ではメールひな形の階層がツリー構造で表示されます。
件名左側の「＋」を押すと下の階層が表示され、「－」を押すと下の階層が非表示になります。

=== 6.3 メールひな形編集
「メールひな形一覧」の件名をクリックします。
「メールひな形明細」画面が開き、「編集」をクリックします。
「メールひな形編集」画面が開き、編集をして「保存」を押したら完了です

=== 6.4 メールひな形削除
「メールひな形明細」画面を開きます。
「削除」を押すと、確認のメッセージが表示され「OK」を押して削除完了です。

== 7 メール管理
配信するメールの作成および送信は以下の手順で行います。
メール管理機能として、登録、一覧、編集、削除、送信先検索機能があります。

===7.1 メール件名、本文作成
サイドメニューの「メール作成」をクリックします。
「メール件名・本文作成」画面が開き、件名、本文、必要であれば回答選択肢（最大10個）を入力します。入力したら「送信先・日時設定へ」を押します。
また、「メールひな形コピー」を押すと、前述6.1で登録したメールひな形が下画面のように表示され、「コピー」をクリックすることで件名と本文を挿入可能です。

=== 7.2 メール送信先、送信日時設定
「送信先・日時設定へ」を押すと、「メール送信先・日時設定へ」が開きます。
送信先はグループのツリー構造で表示されるので、送信するグループにチェックを入れます。また、受信者の「区分」指定が可能です。
配信日時は「即時配信」か、「送信日時予約」の選択式で、送信日時予約は1分単位で設定可能です。
入力が完了したら、「確認」を押します。
「メール作成確認」画面が表示され、「即時配信」ではない場合は「保存」を押してメール作成完了。即時配信の場合、「送信」を押してメール作成終了。

=== 7.3 メール一覧
作成したメールを一覧で参照できます。サイドメニューの「メール一覧」をクリックします。

=== 7.4 メール編集
「メール一覧」画面で「件名」をクリックします。
メール明細が開き、未送信ならば編集も削除も可能で、「編集」をクリックします。
メール件名・本文編集が開き、メールの編集が可能です。
編集完了までの工程はメール作成した時と一緒です。

=== 7.5 メール削除
「メール明細」画面を開きます。
「削除」を押すと、確認のメッセージが表示され、「OK」を押して削除完了です。

=== 7.6 送信結果確認、再送
送信済みのメールは「メール明細」画面を開くと、下の画面のように送信先検索が画面下部に表示され、送信先を絞り込んで検索が可能です。
「検索」を押すと上のように一覧で検索結果が表示され、回答付きメールを送信していた場合、回答状況も表示されます。
また、「再送」にチェックを入れて「再送信」を押すと選択した送信先へ再送信が実行されます。

== 8 管理者管理
所属する団体に登録された受信者へのメール配信機能のみ使用可能な管理者の登録は以下の手順で行います。管理者管理機能として登録、一覧、編集、削除機能があります。

=== 8.1 管理者登録
サイドメニューの「管理者一覧」を選択します。
「管理者一覧」が開き、「新規作成」をクリックします。
「管理者登録」画面が開きます。管理者情報を入力、「確認」を押して管理者登録完了です。


=== 8.2 管理者一覧
「管理者一覧」で登録された管理者の一覧が表示されます。
登録した管理者のメールアドレスとパスワードでログインしますと、以下のような画面になります。
管理者の機能は上記画面のサイドメニューにある「メール作成」とメールの送信、メール一覧の参照のみです。

=== 8.3 管理者編集
「管理者一覧」の「管理者名」をクリックします。
「管理者明細」画面が開き、「管理者編集」をクリックします。
「管理者編集」画面が開きます。管理者情報を編集して、「確認」を押すと編集完了です。

=== 8.4 管理者削除
「管理者明細」画面を開きます。
「削除」を押すと、確認のメッセージが表示され、「OK」を押すと削除完了です。

== 9 受信者機能
登録された受信者アカウントも、登録したメールアドレスとパスワードでログインし、受信者情報の編集、退会などの機能があります。
また団体でユーザーのみ登録、受信者（メールアドレス）の登録は、受信者が空メールを送信して登録する機能があります。

=== 9.1 受信者による登録
まず団体は、前述の3.1の手順でユーザーの登録をします。
登録したユーザーの登録番号とパスワードと空メール送信用のアドレスを受信者本人に渡します。空メール送信用アドレスは、サイドメニューの「受信者登録用アドレス」をクリックすると以下のように表示されます。
受信者は、渡された空メール送信用アドレスに空メールを送信します。
送信後以下の内容のメールが返信されます。

 メール送信ありがとうございます。
 下記アドレスよりをクリックされると登録画面に進むことができます。
 http://hogehoge/sessions/rcnum?og=37&ac=1754


受信者がURLをクリックすると以下の画面が開きます。
受信者は渡された登録番号とパスワードを入力します。
「入力画面へ」を押すと以下の画面が開きます。
受信者情報を入力し（メールアドレスは空メール送信時に取得済みであるため入力不要）、「確認」を押して登録完了です。

=== 9.2 受信者による削除
受信者は登録されたメールアドレスとパスワードでログインします。
ログインすると以下の画面が表示されます。
サイドメニューの「退会手続き」をクリックします。
「退会」画面が開きます。「退会」を押すと確認のメッセージが表示され、「OK」を押すと退会完了し、受信者のデータが削除されます。

== 10 スーパー管理者機能
システム全体の保守・管理機能を持つアカウントとして「スーパー管理者」があります。
具体的機能として、登録された団体の運用停止や再開機能があります。

=== 10.1 団体運用停止・再開
システム導入手順にあるスーパー管理者作成スクリプトで作成したスーパー管理者のメールアドレスおよびパスワードでログインします。
ログインすると団体の一覧が表示されます。
団体の運用を停止する場合は、「運用」の欄の「停止する」をクリックします。
運用を再開する場合は、「団体一覧」画面で「運用」の「再開する」をクリックします。
「運用再開」画面が開きます。「運用再開する」を押すとその団体の運用が再開されます。
